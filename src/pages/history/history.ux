<import name="title-bar" src="../../components/TitleBar/TitleBar.ux"></import>
<import name="videoshow" src="../../components/Video/Video.ux"></import>

<template>
    <div class="page">
        <title-bar title="history.title"></title-bar>
        <image style="position: absolute; margin-top: 245px" if="{{show_loading}}" src="{{anims.loading_src.value}}">
        </image>
        <div class="historylist">
          <videoshow for="{{history}}" video="{{$item}}"></videoshow>
        </div>
        <text style="margin-top: 25px"></text>
    </div>
</template>

<script>
import router from "@system.router"
export default {
  private: {
    history: null,
    show_loading: false,
    anims: {
      loading: null,
      loading_src: {value: "/common/seqanims/loadingWhite/icons8-loading_颜色反转-1.png"}
    }
  },
  async LoadHistory(){
    this.show_loading = true
    this.history = []
    this.anims.loading.start()

    try {
      const medialist = await this.$app.$def.biliclient.getWatchHistory(
        1,
        15
      )
      const videoInfoPromises = medialist.map((media) =>
        this.$app.$def.biliclient.getVideoInfoByBVID(media.bvid)
      )
      this.history = await Promise.all(videoInfoPromises)
    } catch (error) {
      console.error("加载历史记录时发生错误:", error)
    } finally {
      this.show_loading = false
      this.anims.loading.stop()
    }
  },
  OpenVideo(bvid) {
    router.push({
      uri: "pages/videodetail",
      params: {bvid}
    })
  },
  onInit(){
    this.anims.loading = new this.$app.$def.animengine.SequenceAnim(
      "historyVideosPage",
      this.anims.loading_src,
      28,
      "/common/seqanims/loadingWhite/icons8-loading_颜色反转-*.png",
      1000,
      true
    )

    this.LoadHistory()
  }
}
</script>

<style>
.page {
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  position: absolute;
  width: 336px;
}

.historylist {
  margin-top: 10px;
  width: 336px;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}
</style>