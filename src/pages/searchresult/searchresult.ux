<import name="switch-bar" src="../../components/SwitchBar/SwitchBar.ux"></import>
<import name="user" src="../../components/User/User.ux"></import>
<import name="videoshow" src="../../components/Video/Video.ux"></import>
<import name="articleshow" src="../../components/Article/Article.ux"></import>

<template>
  <div class="page">
    <image style="position: absolute; opacity: 0.5" src="/common/rounddevices_searchbg.png"></image>
    <scroll scroll-y="true" class="scroll" bounces="true">
      <switch-bar title="搜索" if="{{!overview_mode}}"></switch-bar>
      <div class="searchbar" if="{{!overview_mode}}" @click="SearchBarClick">
        <image src="/common/searchpage_search.png" style="margin-left: 16px"></image>
        <text style="margin-left: 12px; font-weight: 600; font-size: 25px">{{ keyword }}</text>
      </div>
      <div class="typebar" style="margin-top: 13px" if="{{!overview_mode}}">
        <text class="typetext" style="color: {{typebar_colors.c1}};">综合</text>
        <text class="typetext" style="color: {{typebar_colors.c2}}; margin-left: 20px;">视频</text>
        <text class="typetext" style="color: {{typebar_colors.c3}}; margin-left: 20px;">用户</text>
        <text class="typetext" style="color: {{typebar_colors.c4}}; margin-left: 20px;">专栏</text>
      </div>
      <swiper indicator="false" @change="UpdateTypeBarColors" class="swipermain" style="margin-top: 15px"
        if="{{!show_loading}}" duration="10">
        <div class="swiper_box">
          <scroll class="swiper_container" scroll-y="true" if="{{typebar_if.c1}}" @scroll="ScrollOverviewCheck">
            <div class="tiplabel" if="{{comprehensive_status.has_users_result}}">
              <text class="listtip">用户</text>
            </div>
            <div style="width: 100%; height: 99px; justify-content: center"
              if="{{comprehensive_status.has_users_result}}">
              <user user="{{search.users[0]}}"></user>
            </div>
            <div class="tiplabel" style="margin-top: 10px" if="{{comprehensive_status.has_video_result}}">
              <text class="listtip">视频</text>
            </div>
            <div style="width: 100%; height: 170px; justify-content: center"
              if="{{comprehensive_status.has_video_result}}" for="{{search.comprehensive_videos}}">
              <div style="width: 77%; justify-content: center; margin-top: 5px" onclick="OpenVideo({{$item.bvid}})">
                <videoshow video="{{$item}}"></videoshow>
              </div>
            </div>
            <text style="margin-top: 30px"></text>
          </scroll>
        </div>
        <div class="swiper_box">
          <scroll if="{{typebar_if.c2}}" class="swiper_container" scroll-y="true" @scroll="ScrollOverviewCheck">
            <div style="width: 100%; height: 170px; justify-content: center" for="{{search.videos}}">
              <div style="width: 77%; justify-content: center; margin-top: 5px" onclick="OpenVideo({{$item.bvid}})">
                <videoshow video="{{$item}}"></videoshow>
              </div>
            </div>
            <text style="margin-top: 30px"></text>
          </scroll>
        </div>
        <div class="swiper_box">
          <scroll if="{{typebar_if.c3}}" class="swiper_container" scroll-y="true" @scroll="ScrollOverviewCheck">
            <div style="width: 100%; height: 99px; justify-content: center; margin-top: 5px" for="{{search.users}}">
              <user user="{{$item}}"></user>
            </div>
            <text style="margin-top: 30px"></text>
          </scroll>
        </div>
        <div class="swiper_box">
          <scroll if="{{typebar_if.c4}}" class="swiper_container" scroll-y="true" @scroll="ScrollOverviewCheck">
            <div style="flex-direction: column; align-items: center; width: 100%" for="{{search.articles}}"
              onclick="OpenArticle({{$item}})">
              <articleshow article="{{$item}}" show-category="true"></articleshow>
            </div>
            <text style="margin-top: 30px"></text>
          </scroll>
        </div>
      </swiper>
    </scroll>
    <image style="position: absolute; margin-top: 305px" if="{{show_loading}}" src="{{anims.loading_src.value}}"></image>
  </div>
</template>

<script>
import router from "@system.router"
export default {
  private: {
    search: {},
    overview_mode: false,
    show_loading: true,
    comprehensive_status: {
      has_users_result: true,
      has_video_result: true
    },
    typebar_colors: {
      c1: "",
      c2: "",
      c3: "",
      c4: ""
    },
    typebar_if: {
      c1: false,
      c2: false,
      c3: false,
      c4: false
    },
    anims: {
      loading: null,
      loading_src: {value: "/common/seqanims/loadingWhite/icons8-loading_颜色反转-1.png"},
      loading_position: "305"
    }
  },
  public: {
    keyword: ""
  },
  UpdateTypeBarColors(index) {
    this.typebar_colors = {
      c1: "#919191",
      c2: "#919191",
      c3: "#919191",
      c4: "#919191"
    }
    this.typebar_if = {
      c1: false,
      c2: false,
      c3: false,
      c4: false
    }
    if (index.index >= 0 && index.index < 4) {
      this.typebar_colors[`c${index.index + 1}`] = "#0851ac"
      this.typebar_if[`c${index.index + 1}`] = true
    }
  },
  SearchBarClick() {
    router.back()
  },
  ScrollOverviewCheck(ret) {
    if (ret.scrollY != 0) {
      this.overview_mode = true
    } else {
      this.overview_mode = false
    }
  },
  OpenArticle(item) {
    router.push({
      uri: "pages/articlesave",
      params: {
        cvid: "cv" + item.id,
        cvtitle: item.title
      }
    })
  },
  OpenVideo(bvid) {
    global.runGC()
    console.log("[searchresult -> videodetail] open bvid: " + bvid)
    router.push({
      uri: "pages/videodetail",
      params: {bvid}
    })
  },
  async PatchSearchResult() {
    try {
      // 使用局部变量来减少内存占用
      let videos = []
      let comprehensive_videos = []
      let articles = []

      // 确保 this.search 存在
      const search = this.search || {}

      // 安全地获取数组，如果不存在或不是数组则默认为空数组
      const videosList = Array.isArray(search.videos) ? search.videos : []
      const comprehensiveVideosList = Array.isArray(search.comprehensive_videos)
        ? search.comprehensive_videos
        : []
      const articlesList = Array.isArray(search.articles) ? search.articles : []
      const usersList = Array.isArray(search.users) ? search.users : []

      // 处理 videos
      videosList.forEach((video) => {
        // 确保 video 对象的属性存在
        videos.push({
          pic: video.pic || "",
          title: (video.title || "").replace(/<\/?[^>]+(>|$)/g, "").trim(),
          owner: {name: video.author || "未知"},
          stat: {view: Number(video.play) || 0},
          bvid: video.bvid || ""
        })
      })
      console.log("[searchresult.PatchSearchResult] 已处理视频")

      // 处理 comprehensive_videos
      comprehensiveVideosList.forEach((video) => {
        comprehensive_videos.push({
          pic: video.pic || "",
          title: (video.title || "").replace(/<\/?[^>]+(>|$)/g, "").trim(),
          owner: {name: video.author || "未知"},
          stat: {view: Number(video.play) || 0},
          bvid: video.bvid || ""
        })
      })
      console.log("[searchresult.PatchSearchResult] 已处理综合视频")

      // 处理 articles
      articlesList.forEach((article) => {
        // 确保文章标题存在
        if (article.title) {
          article.title = article.title.replace(/<\/?[^>]+(>|$)/g, "").trim()
        } else {
          article.title = "未命名"
        }
        articles.push(article)
      })
      console.log("[searchresult.PatchSearchResult] 已处理文章")

      // 原地更新 videos 数组，如果不是数组则直接赋值新的数组并记录警告
      if (Array.isArray(search.videos)) {
        search.videos.splice(0, search.videos.length, ...videos)
      } else {
        search.videos = videos
        console.warn("[searchresult.PatchSearchResult] 'videos' 不是数组。已初始化为空数组。")
      }

      // 原地更新 comprehensive_videos 数组，如果不是数组则直接赋值新的数组并记录警告
      if (Array.isArray(search.comprehensive_videos)) {
        search.comprehensive_videos.splice(
          0,
          search.comprehensive_videos.length,
          ...comprehensive_videos
        )
      } else {
        search.comprehensive_videos = comprehensive_videos
        console.warn(
          "[searchresult.PatchSearchResult] 'comprehensive_videos' 不是数组。已初始化为空数组。"
        )
      }

      // 原地更新 articles 数组，如果不是数组则直接赋值新的数组并记录警告
      if (Array.isArray(search.articles)) {
        search.articles.splice(0, search.articles.length, ...articles)
      } else {
        search.articles = articles
        console.warn("[searchresult.PatchSearchResult] 'articles' 不是数组。已初始化为空数组。")
      }

      // 确保 comprehensive_status 存在
      this.comprehensive_status = this.comprehensive_status || {}

      // 更新 comprehensive_status，确保相关数组存在
      this.comprehensive_status.has_users_result = usersList.length > 0
      this.comprehensive_status.has_video_result = videos.length > 0
    } catch (e) {
      console.error("[searchresult.PatchSearchResult] 处理错误:", e)
    }
  },
  async DoSearch() {
    this.show_loading = true
    this.anims.loading.start()

    // 搜视频+推荐用户
    this.search = await this.$app.$def.biliclient.searchContents(this.keyword, 10)
    // 深度搜索用户
    var users = await this.$app.$def.biliclient.searchContentWithType(this.keyword, "bili_user")
    this.search.users = users.result
    // 搜索专栏
    var articles = await this.$app.$def.biliclient.searchContentWithType(this.keyword, "article")
    this.search.articles = articles.result

    await this.PatchSearchResult()

    this.show_loading = false
    this.anims.loading.stop()
  },
  onInit() {
    global.runGC()
    this.UpdateTypeBarColors({index: 0})

    this.anims.loading = new this.$app.$def.animengine.SequenceAnim(
      "searchresultPage",
      this.anims.loading_src,
      28,
      "/common/seqanims/loadingWhite/icons8-loading_颜色反转-*.png",
      1000,
      true
    )

    this.DoSearch()
  }
}
</script>

<style>
.page {
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  position: absolute;
  width: 100%;
}

.scroll {
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  width: 100%;
}

.searchbar {
  background-color: #222222;
  width: 255px;
  height: 50px;
  border-radius: 130px;
  margin-top: 20px;
  flex-direction: row;
  align-items: center;
}

.typebar {
  flex-direction: row;
  width: 257px;
  height: 34px;
}

.typetext {
  font-size: 25px;
  font-weight: 600;
}

.swipermain {
  width: 100%;
  height: 100%;
}

.tiplabel {
  width: 100%;
  height: 50px;
}

.listtip {
  margin-left: 72px;
  font-size: 25px;
  font-weight: 600;
}

.swiper_container {
  width: 100%;
  height: 100%;
  flex-direction: column;
  align-items: center;
}

.swiper_box {
  width: 100%;
  height: 100%;
}
</style>